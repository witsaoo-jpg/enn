<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Discharge Planning (D-M-E-T-H-O-D)</title>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="style.css"> 
    
    <style>
        /* ‡∏à‡∏±‡∏î Layout ‡πÅ‡∏ö‡πà‡∏á‡∏ã‡πâ‡∏≤‡∏¢-‡∏Ç‡∏ß‡∏≤ */
        .layout-container {
            display: grid;
            grid-template-columns: 300px 1fr;
            gap: 20px;
            margin-top: 20px;
            align-items: start;
        }

        .patient-header-card {
            background: white;
            padding: 15px 20px;
            border-radius: 10px;
            box-shadow: var(--shadow);
            border-left: 5px solid var(--primary);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .ph-info h2 { margin: 0 0 5px 0; font-size: 1.4rem; color: #333; }
        .ph-meta { font-size: 1rem; color: #555; font-weight: 500; }
        .ph-meta span { margin-right: 15px; background: #f5f5f5; padding: 4px 10px; border-radius: 5px; }

        /* Sidebar ‡∏î‡πâ‡∏≤‡∏ô‡∏ã‡πâ‡∏≤‡∏¢ */
        .sidebar-card {
            background: white;
            border-radius: 8px;
            box-shadow: var(--shadow);
            padding: 15px;
            height: calc(100vh - 200px);
            overflow-y: auto;
            border: 1px solid #e0e0e0;
            display: flex;
            flex-direction: column;
        }

        /* ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ Template */
        .template-item {
            padding: 10px;
            border-bottom: 1px solid #eee;
            border-radius: 6px;
            margin-bottom: 5px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #f9f9f9;
        }
        .template-item:hover { background-color: #e3f2fd; }
        
        .template-info { cursor: pointer; flex-grow: 1; }
        .template-info strong { display: block; font-size: 0.95rem; color: #333; }
        .template-info small { color: #888; font-size: 0.8rem; }

        .template-actions { display: flex; gap: 5px; }
        .btn-icon {
            border: none; background: none; cursor: pointer; color: #999;
            padding: 5px; border-radius: 4px; transition: 0.2s;
        }
        .btn-icon:hover { background: #ddd; color: #333; }
        .btn-icon.del:hover { background: #ffebee; color: #c62828; }

        /* Form ‡∏î‡πâ‡∏≤‡∏ô‡∏Ç‡∏ß‡∏≤ */
        .form-card {
            background: white;
            border-radius: 8px;
            box-shadow: var(--shadow);
            padding: 30px;
            min-height: calc(100vh - 200px);
        }

        .dm-box { margin-bottom: 20px; }
        .dm-box label { 
            display: block; font-weight: bold; font-size: 1.1rem; 
            margin-bottom: 8px; color: var(--primary-dark);
            background: #e8eaf6; padding: 8px 12px;
            border-radius: 6px; border-left: 5px solid var(--accent);
        }
        .dm-box textarea {
            width: 100%; padding: 12px; border: 1px solid #ccc;
            border-radius: 6px; font-family: 'Sarabun', sans-serif;
            font-size: 1.05rem; line-height: 1.6; min-height: 80px; resize: vertical;
        }

        /* Modal ‡πÄ‡∏û‡∏¥‡πà‡∏°/‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); justify-content: center; align-items: center; z-index: 1000; }
        .modal-content { background: white; padding: 25px; border-radius: 12px; width: 90%; max-width: 600px; max-height: 90vh; overflow-y: auto; }
        .modal-header { font-size: 1.2rem; font-weight: bold; margin-bottom: 15px; color: var(--primary); display: flex; justify-content: space-between; }
        .close-modal { cursor: pointer; font-size: 1.5rem; color: #aaa; }
        .form-row { margin-bottom: 10px; }
        .form-row label { display: block; font-weight: bold; margin-bottom: 3px; font-size: 0.9rem; }
        .form-row input, .form-row textarea { width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 5px; font-family: 'Sarabun'; }

        /* Print Settings */
        .print-only-header { display: none; }
        @media print {
            .navbar, .sidebar-card, .btn-print-group, .modal { display: none !important; }
            .layout-container { display: block; margin: 0; }
            .patient-header-card { display: none; }
            .print-only-header { display: block; text-align: center; margin-bottom: 20px; border-bottom: 2px solid #333; padding-bottom: 10px; }
            .form-card { box-shadow: none; padding: 0; border: none; }
            .dm-box textarea { border: none; resize: none; min-height: auto; padding: 0; margin-bottom: 5px; font-size: 12pt; height: auto; overflow: visible; }
            .dm-box label { background: none; border: none; padding: 0; color: #000; font-weight: bold; text-decoration: underline; margin-bottom: 2px; font-size: 12pt; }
            .dm-box { break-inside: avoid; margin-bottom: 10px; }
            body { background: white; font-size: 12pt; }
            #printContent { display: block; width: 100%; }
        }
    </style>
</head>
<body>

    <nav class="navbar">
        <div style="font-weight:bold; font-size:1.1rem;">
            <i class="fas fa-home"></i> Discharge Planning (D-M-E-T-H-O-D)
        </div>
        <div style="display:flex; gap:10px;">
            <button onclick="window.location.href='index.html'" class="btn" style="background:rgba(255,255,255,0.2); color:white;">
                <i class="fas fa-arrow-left"></i> ‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å
            </button>
        </div>
    </nav>

    <div class="container" style="max-width: 98%;">
        
        <div class="patient-header-card">
            <div class="ph-info">
                <h2><i class="fas fa-user-injured"></i> <span id="ptName">...</span></h2>
                <div class="ph-meta">
                    <span><i class="fas fa-id-card"></i> HN: <span id="ptHN">-</span></span>
                    <span><i class="fas fa-procedures"></i> AN: <span id="ptAN">-</span></span>
                    <span><i class="fas fa-clinic-medical"></i> Ward: <span id="ptWard">-</span></span>
                </div>
            </div>
            <div class="btn-print-group">
                <button class="btn btn-primary" onclick="window.print()" style="font-size:1.1rem; padding: 10px 20px;">
                    <i class="fas fa-print"></i> ‡∏û‡∏¥‡∏°‡∏û‡πå‡πÉ‡∏ö‡∏Å‡∏•‡∏±‡∏ö‡∏ö‡πâ‡∏≤‡∏ô
                </button>
            </div>
        </div>

        <div class="layout-container">
            
            <div class="sidebar-card">
                <div style="display:flex; justify-content:space-between; align-items:center; border-bottom:1px solid #eee; padding-bottom:10px; margin-bottom:10px;">
                    <h3 style="margin:0; color:var(--primary); font-size:1.1rem;"><i class="fas fa-list"></i> ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Å‡∏•‡∏∏‡πà‡∏°‡πÇ‡∏£‡∏Ñ</h3>
                    <button class="btn" onclick="openModal()" style="background:#4caf50; color:white; font-size:0.8rem; padding:5px 10px;">
                        <i class="fas fa-plus"></i> ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà
                    </button>
                </div>

                <input type="text" id="searchTemplate" placeholder="üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ä‡∏∑‡πà‡∏≠‡πÇ‡∏£‡∏Ñ..." 
                       style="width:100%; padding:10px; margin-bottom:10px; border:1px solid #ddd; border-radius:20px; outline:none;"
                       onkeyup="renderTemplates()">
                
                <div id="templateList" style="flex-grow:1; overflow-y:auto;">
                    </div>
                
                <div style="margin-top:10px; text-align:center;">
                    <button class="btn" onclick="resetDefaults()" style="background:#ffebee; color:red; border:1px solid red; font-size:0.8rem; width:100%;">
                        <i class="fas fa-sync"></i> ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô
                    </button>
                </div>
            </div>

            <div id="printContent">
                <div class="print-only-header">
                    <h2>‡πÉ‡∏ö‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏ß‡∏≤‡∏á‡πÅ‡∏ú‡∏ô‡∏à‡∏≥‡∏´‡∏ô‡πà‡∏≤‡∏¢ (Discharge Planning)</h2>
                    <p style="font-size:14pt;"><b>‡∏ä‡∏∑‡πà‡∏≠-‡∏™‡∏Å‡∏∏‡∏•:</b> <span id="pNamePrint"></span> <b>HN:</b> <span id="pHNPrint"></span> <b>Ward:</b> <span id="pWardPrint"></span></p>
                </div>

                <div class="form-card">
                    <div class="dm-box"><label>D - Diagnosis (‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡∏ô‡∏¥‡∏à‡∏â‡∏±‡∏¢‡πÇ‡∏£‡∏Ñ)</label><textarea id="inp_d"></textarea></div>
                    <div class="dm-box"><label>M - Medicine (‡∏¢‡∏≤)</label><textarea id="inp_m"></textarea></div>
                    <div class="dm-box"><label>E - Environment (‡∏™‡∏¥‡πà‡∏á‡πÅ‡∏ß‡∏î‡∏•‡πâ‡∏≠‡∏°)</label><textarea id="inp_e"></textarea></div>
                    <div class="dm-box"><label>T - Treatment (‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏Å‡∏©‡∏≤/‡∏î‡∏π‡πÅ‡∏•‡∏ï‡∏ô‡πÄ‡∏≠‡∏á)</label><textarea id="inp_t"></textarea></div>
                    <div class="dm-box"><label>H - Health (‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û/‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏™‡∏±‡∏á‡πÄ‡∏Å‡∏ï)</label><textarea id="inp_h"></textarea></div>
                    <div class="dm-box"><label>O - Outpatient (‡∏Å‡∏≤‡∏£‡∏ô‡∏±‡∏î‡∏ï‡∏£‡∏ß‡∏à)</label><textarea id="inp_o"></textarea></div>
                    <div class="dm-box"><label>D - Diet (‡∏≠‡∏≤‡∏´‡∏≤‡∏£)</label><textarea id="inp_d2"></textarea></div>
                    
                    <div class="print-only-header" style="border:none; margin-top:50px; text-align:right;">
                        <p>‡∏•‡∏á‡∏ä‡∏∑‡πà‡∏≠‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•‡∏ú‡∏π‡πâ‡∏à‡∏≥‡∏´‡∏ô‡πà‡∏≤‡∏¢ ...........................................................</p>
                        <p>(...........................................................)</p>
                        <p>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ........................................</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="templateModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <span id="modalTitle">‡πÄ‡∏û‡∏¥‡πà‡∏° Template ‡πÇ‡∏£‡∏Ñ‡πÉ‡∏´‡∏°‡πà</span>
                <span class="close-modal" onclick="closeModal()">&times;</span>
            </div>
            <input type="hidden" id="editId">
            <div class="form-row">
                <label>‡∏ä‡∏∑‡πà‡∏≠‡πÇ‡∏£‡∏Ñ / ‡∏Å‡∏•‡∏∏‡πà‡∏°‡πÇ‡∏£‡∏Ñ (Title):</label>
                <input type="text" id="t_title" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏ú‡πà‡∏≤‡∏ï‡∏±‡∏î‡πÑ‡∏™‡πâ‡∏ï‡∏¥‡πà‡∏á, ‡πÄ‡∏ö‡∏≤‡∏´‡∏ß‡∏≤‡∏ô">
            </div>
            <div class="form-row"><label>D - Diagnosis:</label><textarea id="t_d" rows="2"></textarea></div>
            <div class="form-row"><label>M - Medicine:</label><textarea id="t_m" rows="2"></textarea></div>
            <div class="form-row"><label>E - Environment:</label><textarea id="t_e" rows="2"></textarea></div>
            <div class="form-row"><label>T - Treatment:</label><textarea id="t_t" rows="2"></textarea></div>
            <div class="form-row"><label>H - Health:</label><textarea id="t_h" rows="2"></textarea></div>
            <div class="form-row"><label>O - Outpatient:</label><textarea id="t_o" rows="2"></textarea></div>
            <div class="form-row"><label>D - Diet:</label><textarea id="t_d2" rows="2"></textarea></div>
            
            <div style="text-align:right; margin-top:15px;">
                <button class="btn" onclick="closeModal()" style="background:#ccc; color:#333;">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                <button class="btn btn-primary" onclick="saveTemplate()">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
            </div>
        </div>
    </div>

<script>
    // 1. ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢
    const patientProfile = JSON.parse(localStorage.getItem('patientProfile'));
    if(patientProfile) {
        document.getElementById('ptName').innerText = patientProfile.name;
        document.getElementById('ptHN').innerText = patientProfile.hn;
        document.getElementById('ptAN').innerText = patientProfile.an;
        document.getElementById('ptWard').innerText = patientProfile.ward;
        
        // Print Header
        document.getElementById('pNamePrint').innerText = patientProfile.name;
        document.getElementById('pHNPrint').innerText = patientProfile.hn;
        document.getElementById('pWardPrint').innerText = patientProfile.ward;
    } else {
        alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡∏Å‡πà‡∏≠‡∏ô‡∏Ñ‡∏£‡∏±‡∏ö"); window.location.href = 'ward.html';
    }

    // 2. ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Default (‡∏Å‡∏£‡∏ì‡∏µ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà)
    const defaultTemplates = [
        { id: 'SURG01', title: '‡πÑ‡∏™‡πâ‡∏ï‡∏¥‡πà‡∏á‡∏≠‡∏±‡∏Å‡πÄ‡∏™‡∏ö (Post-op Appendectomy)', d: '‡πÇ‡∏£‡∏Ñ‡πÑ‡∏™‡πâ‡∏ï‡∏¥‡πà‡∏á‡∏≠‡∏±‡∏Å‡πÄ‡∏™‡∏ö‡πÄ‡∏â‡∏µ‡∏¢‡∏ö‡∏û‡∏•‡∏±‡∏ô ‡∏ú‡πà‡∏≤‡∏ï‡∏±‡∏î‡πÄ‡∏≠‡∏≤‡πÑ‡∏™‡πâ‡∏ï‡∏¥‡πà‡∏á‡∏≠‡∏≠‡∏Å‡πÅ‡∏•‡πâ‡∏ß', m: '1. Paracetamol 500 mg ‡πÅ‡∏Å‡πâ‡∏õ‡∏ß‡∏î\n2. Antibiotics ‡∏ó‡∏≤‡∏ô‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö', e: '‡∏à‡∏±‡∏î‡∏´‡πâ‡∏≠‡∏á‡∏ô‡∏≠‡∏ô‡∏™‡∏∞‡∏≠‡∏≤‡∏î ‡∏≠‡∏≤‡∏Å‡∏≤‡∏®‡∏ñ‡πà‡∏≤‡∏¢‡πÄ‡∏ó ‡∏á‡∏î‡πÄ‡∏î‡∏¥‡∏ô‡∏Ç‡∏∂‡πâ‡∏ô‡∏•‡∏á‡∏ö‡∏±‡∏ô‡πÑ‡∏î', t: '1. ‡∏´‡πâ‡∏≤‡∏°‡πÅ‡∏ú‡∏•‡πÇ‡∏î‡∏ô‡∏ô‡πâ‡∏≥ 7 ‡∏ß‡∏±‡∏ô\n2. ‡∏´‡πâ‡∏≤‡∏°‡∏¢‡∏Å‡∏Ç‡∏≠‡∏á‡∏´‡∏ô‡∏±‡∏Å > 5 ‡∏Å‡∏Å.\n3. ‡πÄ‡∏î‡∏¥‡∏ô‡∏¢‡∏∑‡∏î‡∏ï‡∏±‡∏ß‡∏ö‡πà‡∏≠‡∏¢‡πÜ', h: '‡∏™‡∏±‡∏á‡πÄ‡∏Å‡∏ï: ‡πÑ‡∏Ç‡πâ‡∏™‡∏π‡∏á, ‡πÅ‡∏ú‡∏•‡∏ö‡∏ß‡∏°‡πÅ‡∏î‡∏á, ‡∏õ‡∏ß‡∏î‡∏ó‡πâ‡∏≠‡∏á‡∏£‡∏∏‡∏ô‡πÅ‡∏£‡∏á ‡πÉ‡∏´‡πâ‡∏£‡∏µ‡∏ö‡∏°‡∏≤ ‡∏£‡∏û.', o: '‡∏ô‡∏±‡∏î‡∏ï‡∏±‡∏î‡πÑ‡∏´‡∏°‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà .................. ‡πÄ‡∏ß‡∏•‡∏≤ .................. ‡∏´‡πâ‡∏≠‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏®‡∏±‡∏•‡∏¢‡∏Å‡∏£‡∏£‡∏°', d2: '‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏≠‡πà‡∏≠‡∏ô‡∏¢‡πà‡∏≠‡∏¢‡∏á‡πà‡∏≤‡∏¢ ‡πÄ‡∏ô‡πâ‡∏ô‡∏ú‡∏±‡∏Å‡∏ú‡∏•‡πÑ‡∏°‡πâ ‡∏î‡∏∑‡πà‡∏°‡∏ô‡πâ‡∏≥‡∏°‡∏≤‡∏Å‡πÜ' },
        { id: 'MED01', title: '‡∏õ‡∏≠‡∏î‡∏≠‡∏±‡∏Å‡πÄ‡∏™‡∏ö (Pneumonia)', d: '‡πÇ‡∏£‡∏Ñ‡∏õ‡∏≠‡∏î‡∏≠‡∏±‡∏Å‡πÄ‡∏™‡∏ö ‡∏£‡∏±‡∏Å‡∏©‡∏≤‡∏à‡∏ô‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡∏î‡∏µ‡∏Ç‡∏∂‡πâ‡∏ô', m: '1. ‡∏ó‡∏≤‡∏ô‡∏¢‡∏≤‡∏õ‡∏è‡∏¥‡∏ä‡∏µ‡∏ß‡∏ô‡∏∞‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö\n2. ‡∏¢‡∏≤‡∏•‡∏∞‡∏•‡∏≤‡∏¢‡πÄ‡∏™‡∏°‡∏´‡∏∞', e: '‡∏´‡∏•‡∏µ‡∏Å‡πÄ‡∏•‡∏µ‡πà‡∏¢‡∏á‡∏Ñ‡∏ß‡∏±‡∏ô‡∏ö‡∏∏‡∏´‡∏£‡∏µ‡πà ‡∏ù‡∏∏‡πà‡∏ô‡∏•‡∏∞‡∏≠‡∏≠‡∏á', t: '1. ‡∏ù‡∏∂‡∏Å‡∏´‡∏≤‡∏¢‡πÉ‡∏à‡∏•‡∏∂‡∏Å‡πÜ\n2. ‡∏û‡∏±‡∏Å‡∏ú‡πà‡∏≠‡∏ô‡πÉ‡∏´‡πâ‡πÄ‡∏û‡∏µ‡∏¢‡∏á‡∏û‡∏≠\n3. ‡πÉ‡∏™‡πà‡∏´‡∏ô‡πâ‡∏≤‡∏Å‡∏≤‡∏Å‡∏≠‡∏ô‡∏≤‡∏°‡∏±‡∏¢', h: '‡∏´‡∏≤‡∏Å‡πÑ‡∏Ç‡πâ‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤ ‡∏´‡∏≠‡∏ö‡πÄ‡∏´‡∏ô‡∏∑‡πà‡∏≠‡∏¢ ‡πÑ‡∏≠‡πÄ‡∏™‡∏°‡∏´‡∏∞‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏µ ‡πÉ‡∏´‡πâ‡∏°‡∏≤‡∏û‡∏ö‡πÅ‡∏û‡∏ó‡∏¢‡πå', o: '‡∏ô‡∏±‡∏î X-ray ‡∏õ‡∏≠‡∏î‡∏ã‡πâ‡∏≥‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ..................', d2: '‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏Ñ‡∏£‡∏ö 5 ‡∏´‡∏°‡∏π‡πà ‡∏õ‡∏£‡∏∏‡∏á‡∏™‡∏∏‡∏Å‡∏™‡∏∞‡∏≠‡∏≤‡∏î ‡∏î‡∏∑‡πà‡∏°‡∏ô‡πâ‡∏≥‡∏≠‡∏∏‡πà‡∏ô' }
    ];

    // 3. ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (Local Storage CRUD)
    let templates = JSON.parse(localStorage.getItem('dmethod_templates'));
    if(!templates || templates.length === 0) {
        templates = defaultTemplates;
        localStorage.setItem('dmethod_templates', JSON.stringify(templates));
    }

    // Render List
    function renderTemplates() {
        const searchText = document.getElementById('searchTemplate').value.toLowerCase();
        const listDiv = document.getElementById('templateList');
        listDiv.innerHTML = '';

        const filtered = templates.filter(t => t.title.toLowerCase().includes(searchText));

        if(filtered.length === 0) { listDiv.innerHTML = '<div style="text-align:center; color:#999; padding:20px;">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</div>'; return; }

        filtered.forEach((t, index) => {
            const div = document.createElement('div');
            div.className = 'template-item';
            div.innerHTML = `
                <div class="template-info" onclick="fillForm('${t.id}')">
                    <strong>${t.title}</strong>
                </div>
                <div class="template-actions">
                    <button class="btn-icon" onclick="openModal('${t.id}')" title="‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç"><i class="fas fa-pen"></i></button>
                    <button class="btn-icon del" onclick="deleteTemplate('${t.id}')" title="‡∏•‡∏ö"><i class="fas fa-trash"></i></button>
                </div>
            `;
            listDiv.appendChild(div);
        });
    }

    // Fill Form
    function fillForm(id) {
        const data = templates.find(t => t.id === id);
        if(!data) return;
        document.getElementById('inp_d').value = data.d || '';
        document.getElementById('inp_m').value = data.m || '';
        document.getElementById('inp_e').value = data.e || '';
        document.getElementById('inp_t').value = data.t || '';
        document.getElementById('inp_h').value = data.h || '';
        document.getElementById('inp_o').value = data.o || '';
        document.getElementById('inp_d2').value = data.d2 || '';
    }

    // Modal & CRUD Operations
    function openModal(id = null) {
        const modal = document.getElementById('templateModal');
        const titleEl = document.getElementById('modalTitle');
        document.getElementById('editId').value = '';
        
        // Clear inputs
        ['title','d','m','e','t','h','o','d2'].forEach(k => document.getElementById('t_'+k).value = '');

        if(id) {
            const t = templates.find(x => x.id === id);
            if(t) {
                titleEl.innerText = '‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç Template';
                document.getElementById('editId').value = t.id;
                document.getElementById('t_title').value = t.title;
                document.getElementById('t_d').value = t.d;
                document.getElementById('t_m').value = t.m;
                document.getElementById('t_e').value = t.e;
                document.getElementById('t_t').value = t.t;
                document.getElementById('t_h').value = t.h;
                document.getElementById('t_o').value = t.o;
                document.getElementById('t_d2').value = t.d2;
            }
        } else {
            titleEl.innerText = '‡πÄ‡∏û‡∏¥‡πà‡∏° Template ‡πÇ‡∏£‡∏Ñ‡πÉ‡∏´‡∏°‡πà';
        }
        modal.style.display = 'flex';
    }

    function closeModal() { document.getElementById('templateModal').style.display = 'none'; }

    function saveTemplate() {
        const id = document.getElementById('editId').value;
        const newObj = {
            id: id ? id : 'CUSTOM_' + Date.now(),
            title: document.getElementById('t_title').value,
            d: document.getElementById('t_d').value,
            m: document.getElementById('t_m').value,
            e: document.getElementById('t_e').value,
            t: document.getElementById('t_t').value,
            h: document.getElementById('t_h').value,
            o: document.getElementById('t_o').value,
            d2: document.getElementById('t_d2').value
        };

        if(!newObj.title) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠‡πÇ‡∏£‡∏Ñ");

        if(id) {
            // Edit
            const index = templates.findIndex(t => t.id === id);
            templates[index] = newObj;
        } else {
            // Add
            templates.push(newObj);
        }

        localStorage.setItem('dmethod_templates', JSON.stringify(templates));
        renderTemplates();
        closeModal();
    }

    function deleteTemplate(id) {
        if(confirm("‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö Template ‡∏ô‡∏µ‡πâ‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?")) {
            templates = templates.filter(t => t.id !== id);
            localStorage.setItem('dmethod_templates', JSON.stringify(templates));
            renderTemplates();
        }
    }

    function resetDefaults() {
        if(confirm("‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏≠‡∏á‡∏à‡∏∞‡∏´‡∏≤‡∏¢‡πÑ‡∏õ ‡πÅ‡∏•‡∏∞‡∏Å‡∏•‡∏±‡∏ö‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÑ‡∏´‡∏°?")) {
            templates = defaultTemplates;
            localStorage.setItem('dmethod_templates', JSON.stringify(templates));
            renderTemplates();
        }
    }

    // Init
    renderTemplates();

</script>
</body>
</html>

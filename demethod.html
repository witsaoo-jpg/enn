<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Discharge Planning (D-M-E-T-H-O-D)</title>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        :root {
            --primary: #00796b;
            --primary-dark: #004d40;
            --primary-light: #e0f2f1;
            --accent: #2e7d32;
            --danger: #c62828;
            --shadow: 0 2px 8px rgba(0,0,0,0.08);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { background: #f4f7f6; font-family: 'Sarabun', sans-serif; color: #333; }

        .no-print { display: block; }

        /* Navbar */
        .navbar {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            padding: 15px 30px; display: flex; justify-content: space-between; align-items: center;
            color: white; box-shadow: var(--shadow); position: sticky; top: 0; z-index: 100;
        }

        /* Patient Header */
        .patient-header {
            background: white; margin: 20px auto; max-width: 1400px; padding: 20px;
            border-radius: 12px; box-shadow: var(--shadow); border-left: 6px solid var(--primary);
            display: flex; justify-content: space-between; align-items: center;
        }

        .layout {
            display: grid; grid-template-columns: 350px 1fr; gap: 20px;
            max-width: 1400px; margin: 0 auto 40px; padding: 0 20px;
        }

        /* Sidebar */
        .sidebar {
            background: white; padding: 20px; border-radius: 12px; box-shadow: var(--shadow);
            height: fit-content; position: sticky; top: 90px;
        }
        .template-list { margin-top: 15px; max-height: 400px; overflow-y: auto; }
        .template-item { 
            padding: 12px; border: 1px solid #eee; margin-bottom: 8px; border-radius: 8px;
            cursor: pointer; transition: 0.2s; font-size: 0.9rem;
        }
        .template-item:hover { background: var(--primary-light); border-color: var(--primary); }

        /* Main Form */
        .main-content { background: white; padding: 30px; border-radius: 12px; box-shadow: var(--shadow); }
        .dm-group { margin-bottom: 20px; }
        .dm-group label { display: block; font-weight: bold; margin-bottom: 8px; color: var(--primary-dark); }
        .dm-group textarea { 
            width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px;
            font-family: 'Sarabun'; font-size: 1rem; line-height: 1.6; min-height: 100px;
        }

        /* History Log */
        .history-box {
            margin-top: 30px; padding-top: 20px; border-top: 2px solid #eee;
        }
        .history-item {
            background: #f9f9f9; padding: 12px; border-radius: 8px; margin-bottom: 10px;
            border-left: 4px solid #999; font-size: 0.85rem;
        }
        .history-item b { color: var(--primary); }

        /* Print Settings */
        @media print {
            .no-print, .navbar, .sidebar, .btn-group { display: none !important; }
            body { background: white; }
            .layout { display: block; }
            .patient-header { border: 2px solid #333; box-shadow: none; margin-bottom: 30px; }
            .main-content { box-shadow: none; padding: 0; }
            .dm-group textarea { border: none; padding: 0; min-height: auto; overflow: visible; }
            .dm-group label { text-decoration: underline; font-size: 1.1rem; }
            .history-box { display: none; } /* ซ่อนประวัติเวลาพิมพ์ให้คนไข้ */
        }

        .btn {
            padding: 10px 20px; border-radius: 8px; border: none; cursor: pointer;
            font-weight: bold; display: inline-flex; align-items: center; gap: 8px;
        }
        .btn-save { background: var(--accent); color: white; }
        .btn-print { background: var(--primary); color: white; }
        .btn-clear { background: #eee; color: #666; }
    </style>
</head>
<body>

<nav class="navbar no-print">
    <div style="font-size: 1.2rem; font-weight: bold;"><i class="fas fa-file-medical"></i> Discharge Planning Tool</div>
    <button class="btn" style="background: rgba(255,255,255,0.2); color: white;" onclick="window.location.href='index.html'"><i class="fas fa-arrow-left"></i> กลับ</button>
</nav>

<div class="patient-header">
    <div>
        <h2 id="disp_name">ชื่อคนไข้</h2>
        <p style="color: #666;">HN: <span id="disp_hn">-</span> | AN: <span id="disp_an">-</span> | Ward: <span id="disp_ward">-</span></p>
    </div>
    <div class="btn-group no-print">
        <button class="btn btn-print" onclick="window.print()"><i class="fas fa-print"></i> พิมพ์ใบกลับบ้าน (PDF)</button>
    </div>
</div>

<div class="layout">
    <div class="sidebar no-print">
        <div style="font-weight: bold; color: var(--primary);">1. เลือกกลุ่มโรค</div>
        <input type="text" id="searchBox" placeholder="ค้นหาโรค..." onkeyup="filterList()" style="width: 100%; padding: 8px; margin-top: 10px; border-radius: 5px; border: 1px solid #ddd;">
        <div class="template-list" id="templateList">
            </div>
        <hr style="margin: 20px 0;">
        <div style="font-size: 0.8rem; color: #999;">* ข้อมูลจะถูกบันทึกแยกรายบุคคลตาม HN</div>
    </div>

    <div class="main-content">
        <div class="action-toolbar no-print" style="display: flex; justify-content: flex-end; gap: 10px; margin-bottom: 20px;">
            <button class="btn btn-clear" onclick="clearForm()"><i class="fas fa-eraser"></i> ล้างช่องกรอก</button>
            <button class="btn btn-save" onclick="saveData()"><i class="fas fa-save"></i> บันทึกข้อมูลและลงประวัติ</button>
        </div>

        <div class="dm-group">
            <label>D - Diagnosis (การวินิจฉัยและแผนการรักษา)</label>
            <textarea id="inp_d"></textarea>
        </div>
        <div class="dm-group">
            <label>M - Medicine (ยาที่ได้รับกลับบ้านและการใช้ยา)</label>
            <textarea id="inp_m"></textarea>
        </div>
        <div class="dm-group">
            <label>E - Environment (การจัดสิ่งแวดล้อมที่บ้าน)</label>
            <textarea id="inp_e"></textarea>
        </div>
        <div class="dm-group">
            <label>T - Treatment (การดูแลแผล/อุปกรณ์/การเฝ้าสังเกต)</label>
            <textarea id="inp_t"></textarea>
        </div>
        <div class="dm-group">
            <label>H - Health (อาการผิดปกติที่ต้องรีบมาโรงพยาบาล)</label>
            <textarea id="inp_h"></textarea>
        </div>
        <div class="dm-group">
            <label>O - Outpatient (การนัดหมายติดตามอาการ)</label>
            <textarea id="inp_o"></textarea>
        </div>
        <div class="dm-group">
            <label>D - Diet (การรับประทานอาหารที่เหมาะสม)</label>
            <textarea id="inp_d2"></textarea>
        </div>

        <div class="history-box no-print">
            <h3 style="font-size: 1rem; margin-bottom: 15px; color: #666;"><i class="fas fa-history"></i> ประวัติการลงบันทึก (Timeline)</h3>
            <div id="historyLog">
                <div style="color: #ccc; font-style: italic;">ยังไม่มีประวัติการบันทึก</div>
            </div>
        </div>
    </div>
</div>

<script>
    // 1. คลังข้อมูล Template (เพิ่มได้เองที่นี่)
    const masterTemplates = [
        { id: 'APP', title: 'ผ่าตัดไส้ติ่ง (Appendectomy)', d: 'ไส้ติ่งอักเสบ ได้รับการผ่าตัดเรียบร้อย', m: 'พาราเซตามอล 500มก. ทานทุก 6 ชม. เวลามีอาการปวด', e: 'จัดที่นอนชั้นล่าง ลดการเดินขึ้นลงบันไดใน 7 วันแรก', t: 'รักษาแผลให้แห้ง ห้ามโดนน้ำจนกว่าจะตัดไหม (7 วัน)', h: 'มีไข้สูง แผลบวมแดง มีหนอง ปวดท้องรุนแรง', o: 'นัดตัดไหม 7 วันหลังผ่าตัด ที่ห้องตรวจศัลยกรรม', d2: 'อาหารอ่อนย่อยง่าย งดของหมักดองและแอลกอฮอล์' },
        { id: 'DM', title: 'เบาหวาน (Diabetes)', d: 'โรคเบาหวาน ควบคุมระดับน้ำตาล', m: 'ยาลดน้ำตาลทานก่อนอาหารเช้า-เย็น ห้ามหยุดยาเอง', e: 'วางของใช้ให้เป็นระเบียบ ป้องกันการเดินชน/หกล้ม', t: 'ตรวจเท้าทุกวัน สวมรองเท้าเดินในบ้านเสมอ', h: 'หน้ามืด ใจสั่น เหงื่อออก (น้ำตาลต่ำ) หรือซึมลง หายใจหอบ', o: 'นัดตรวจเลือดติดตามผล ทุก 1-3 เดือน', d2: 'เน้นผักใบเขียว ลดข้าว แป้ง และผลไม้รสหวานจัด' }
    ];

    // 2. จัดการข้อมูลคนไข้
    let profile = JSON.parse(localStorage.getItem('patientProfile')) || { name: 'ไม่ได้เลือกคนไข้', hn: '0000', an: '0000', ward: '-' };
    const hn = profile.hn;

    window.onload = function() {
        document.getElementById('disp_name').innerText = profile.name;
        document.getElementById('disp_hn').innerText = profile.hn;
        document.getElementById('disp_an').innerText = profile.an;
        document.getElementById('disp_ward').innerText = profile.ward;
        
        renderTemplateList();
        loadPatientData();
    };

    function renderTemplateList() {
        const list = document.getElementById('templateList');
        list.innerHTML = masterTemplates.map(t => `
            <div class="template-item" onclick="applyTemplate('${t.id}')">
                <strong>${t.title}</strong>
            </div>
        `).join('');
    }

    function applyTemplate(id) {
        const t = masterTemplates.find(x => x.id === id);
        if(!t) return;
        if(confirm(`ต้องการใช้ข้อความจากกลุ่มโรค "${t.title}" ใช่หรือไม่?`)) {
            document.getElementById('inp_d').value = t.d;
            document.getElementById('inp_m').value = t.m;
            document.getElementById('inp_e').value = t.e;
            document.getElementById('inp_t').value = t.t;
            document.getElementById('inp_h').value = t.h;
            document.getElementById('inp_o').value = t.o;
            document.getElementById('inp_d2').value = t.d2;
        }
    }

    function filterList() {
        const val = document.getElementById('searchBox').value.toLowerCase();
        const items = document.getElementsByClassName('template-item');
        Array.from(items).forEach(item => {
            item.style.display = item.innerText.toLowerCase().includes(val) ? 'block' : 'none';
        });
    }

    // 3. ระบบบันทึกและประวัติ (History CRUD)
    function saveData() {
        const data = {
            d: document.getElementById('inp_d').value,
            m: document.getElementById('inp_m').value,
            e: document.getElementById('inp_e').value,
            t: document.getElementById('inp_t').value,
            h: document.getElementById('inp_h').value,
            o: document.getElementById('inp_o').value,
            d2: document.getElementById('inp_d2').value
        };

        // บันทึกข้อมูลปัจจุบัน
        localStorage.setItem(`discharge_data_${hn}`, JSON.stringify(data));

        // บันทึกลงประวัติ (History Log)
        let history = JSON.parse(localStorage.getItem(`discharge_history_${hn}`)) || [];
        const newLog = {
            time: new Date().toLocaleString('th-TH'),
            user: "พยาบาลประจำตึก", // ในอนาคตดึงจากระบบ Login ได้
            action: "บันทึก/แก้ไขข้อมูล D-M-E-T-H-O-D"
        };
        history.unshift(newLog); // เอาอันใหม่ไว้บน
        localStorage.setItem(`discharge_history_${hn}`, JSON.stringify(history.slice(0, 5))); // เก็บแค่ 5 รายการล่าสุดพอ

        loadPatientData();
        alert("บันทึกข้อมูลและลงประวัติเรียบร้อยแล้ว");
    }

    function loadPatientData() {
        const saved = JSON.parse(localStorage.getItem(`discharge_data_${hn}`));
        if(saved) {
            document.getElementById('inp_d').value = saved.d || "";
            document.getElementById('inp_m').value = saved.m || "";
            document.getElementById('inp_e').value = saved.e || "";
            document.getElementById('inp_t').value = saved.t || "";
            document.getElementById('inp_h').value = saved.h || "";
            document.getElementById('inp_o').value = saved.o || "";
            document.getElementById('inp_d2').value = saved.d2 || "";
        }

        const history = JSON.parse(localStorage.getItem(`discharge_history_${hn}`));
        const logDiv = document.getElementById('historyLog');
        if(history && history.length > 0) {
            logDiv.innerHTML = history.map(h => `
                <div class="history-item">
                    <b><i class="fas fa-clock"></i> ${h.time}</b> โดย <b>${h.user}</b><br>
                    <span>${h.action}</span>
                </div>
            `).join('');
        }
    }

    function clearForm() {
        if(confirm("ล้างข้อความในช่องกรอกทั้งหมด?")) {
            const ids = ['d','m','e','t','h','o','d2'];
            ids.forEach(id => document.getElementById('inp_'+id).value = "");
        }
    }
</script>

</body>
</html>

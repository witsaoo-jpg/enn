<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PFE - Patient and Family Education</title>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <style>
        :root {
            --primary: #00796b;
            --primary-light: #e0f2f1;
            --primary-dark: #004d40;
            --text-dark: #263238;
            --text-grey: #546e7a;
            --border: #cfd8dc;
            --radius: 8px;
        }

        * { box-sizing: border-box; }

        body {
            font-family: 'Sarabun', sans-serif;
            background: #f0f2f5;
            margin: 0;
            padding-top: 70px;
            padding-bottom: 80px;
            color: var(--text-dark);
            font-size: 14px;
        }

        /* --- Fixed Nav Bar (UI Only) --- */
        .patient-header-bar {
            position: fixed; top: 0; left: 0; width: 100%;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white; padding: 10px 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            z-index: 1000;
            display: flex; justify-content: space-between; align-items: center;
        }
        .patient-info-display { font-size: 1.1rem; font-weight: 500; display: flex; gap: 15px; }
        .patient-badge { background: rgba(255,255,255,0.2); padding: 4px 12px; border-radius: 20px; font-size: 0.9rem; }
        
        .back-btn {
            background: white; color: var(--primary); border: none; padding: 6px 15px;
            border-radius: 20px; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 5px; text-decoration: none; font-size: 14px;
        }

        /* --- Main Layout for PDF Repeating Header --- */
        /* เทคนิค: ใช้ Table ใหญ่ครอบทั้งหน้า เพื่อให้ thead ซ้ำทุกหน้า */
        .master-layout-table {
            width: 210mm;
            margin: 20px auto;
            background: white;
            border-collapse: collapse;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
        }
        
        .master-layout-table thead {
            display: table-header-group; /* หัวตารางซ้ำทุกหน้า */
        }
        
        .master-layout-table tbody {
            display: table-row-group;
        }

        .master-layout-table td {
            padding: 0;
            vertical-align: top;
        }

        /* Container Padding inside the table */
        .content-padding { padding: 30px; }

        /* --- Form Header Style --- */
        .form-header {
            border-bottom: 3px double var(--primary-light); 
            padding-bottom: 15px; margin-bottom: 20px;
            display: flex; justify-content: space-between; align-items: center;
        }
        .hospital-logo { display: flex; align-items: center; gap: 15px; }
        .logo-placeholder { width: 50px; height: 50px; background: var(--primary-light); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: var(--primary-dark); }
        .form-title h2 { margin: 0; color: var(--primary); font-size: 18px; }
        .form-title h3 { margin: 0; color: var(--text-grey); font-size: 14px; font-weight: 400; }

        /* Patient Info Box (แทน Sticker) */
        .patient-info-box {
            background: #f1f8e9;
            border: 1px solid #c5e1a5;
            border-radius: 6px;
            padding: 10px 15px;
            text-align: right;
            min-width: 250px;
        }
        .pt-name { font-weight: bold; font-size: 16px; color: var(--primary-dark); }
        .pt-meta { font-size: 13px; color: var(--text-grey); margin-top: 2px; }

        /* --- Info Grid --- */
        .info-grid {
            display: grid; grid-template-columns: repeat(12, 1fr); gap: 15px;
            background: #f8fcfc; padding: 15px; border-radius: var(--radius); border: 1px solid #e0f2f1;
            margin-bottom: 20px;
        }
        .col-span-3 { grid-column: span 3; }
        .col-span-4 { grid-column: span 4; }
        .col-span-6 { grid-column: span 6; }
        .col-span-12 { grid-column: span 12; }

        .form-group label { display: block; font-size: 12px; font-weight: 600; color: var(--primary); margin-bottom: 4px; }
        .input-line {
            width: 100%; border: none; border-bottom: 1px solid #ccc; background: transparent;
            padding: 5px 0; font-family: 'Sarabun';
        }
        .radio-group { display: flex; gap: 15px; align-items: center; margin-top: 5px; }

        /* --- Table Styling --- */
        .dmethod-table {
            width: 100%; border-collapse: separate; border-spacing: 0;
            border: 1px solid var(--border); border-radius: var(--radius); overflow: hidden;
            margin-bottom: 20px;
        }
        .dmethod-table th { background: var(--primary); color: white; padding: 10px; text-align: left; font-size: 13px; }
        .dmethod-table td { border-bottom: 1px solid #eee; padding: 10px; vertical-align: top; background: white; }
        
        .col-topic { width: 35%; }
        .col-eval { width: 10%; text-align: center; }
        .col-recv { width: 15%; }
        .col-method { width: 15%; }
        .col-inst { width: 25%; }

        .topic-header { color: var(--primary-dark); font-weight: bold; font-size: 14px; }
        .sub-topic { margin-left: 15px; color: var(--text-grey); font-size: 13px; }

        /* --- History Section --- */
        .history-section {
            margin-top: 30px;
            border-top: 2px dashed #eee;
            padding-top: 20px;
        }
        .history-title { font-weight: bold; color: var(--primary); margin-bottom: 10px; font-size: 14px; }
        .history-table { width: 100%; border-collapse: collapse; font-size: 12px; }
        .history-table th { background: #eee; text-align: left; padding: 5px; border-bottom: 1px solid #ccc; }
        .history-table td { padding: 5px; border-bottom: 1px solid #eee; color: #555; }

        /* --- Action Bar --- */
        .action-bar {
            position: fixed; bottom: 0; left: 0; width: 100%;
            background: white; padding: 10px 20px;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.05);
            display: flex; justify-content: flex-end; gap: 10px;
            z-index: 1000;
        }
        .btn {
            padding: 10px 20px; border: none; border-radius: 30px; cursor: pointer;
            font-family: 'Sarabun'; font-weight: 600; font-size: 14px;
            display: flex; align-items: center; gap: 8px; transition: 0.2s;
        }
        .btn-save { background: #2e7d32; color: white; }
        .btn-delete { background: #ef5350; color: white; }
        .btn-pdf { background: #ff9800; color: white; }

        @media print {
            .patient-header-bar, .action-bar { display: none !important; }
            .master-layout-table { box-shadow: none; margin: 0; width: 100%; }
            body { background: white; padding: 0; }
            /* Force header repeat */
            thead { display: table-header-group; }
            tfoot { display: table-footer-group; }
        }
    </style>
</head>
<body>

    <nav class="patient-header-bar">
        <button class="back-btn" onclick="window.location.href='patient_list.html'">
            <i class="fas fa-chevron-left"></i> ย้อนกลับ
        </button>
        <div class="patient-info-display">
            <div class="patient-badge"><i class="fas fa-user-circle"></i> <span id="navName">Loading...</span></div>
            <div class="patient-badge"><i class="fas fa-id-card"></i> HN: <span id="navHN">-</span></div>
        </div>
    </nav>

    <table class="master-layout-table" id="printableArea">
        <thead>
            <tr>
                <td>
                    <div class="content-padding" style="padding-bottom: 10px;">
                        <div class="form-header">
                            <div class="hospital-logo">
                                <div class="logo-placeholder"><i class="fas fa-hospital-symbol fa-2x"></i></div>
                                <div class="form-title">
                                    <h2>โรงพยาบาลชลบุรี</h2>
                                    <h3>Chonburi Hospital</h3>
                                    <div style="font-weight: 700; color: var(--primary-dark); margin-top: 5px;">แบบบันทึกการสอนผู้ป่วย (PFE)</div>
                                </div>
                            </div>
                            <div class="patient-info-box" id="headerPatientInfo">
                                </div>
                        </div>
                    </div>
                </td>
            </tr>
        </thead>
        <tbody>
            <tr>
                <td>
                    <div class="content-padding" style="padding-top: 0;">
                        
                        <div class="info-grid">
                            <div class="col-span-3 form-group">
                                <label>วันที่ Admit</label>
                                <input type="date" id="admit_date" class="input-line" onchange="calcLOS()">
                            </div>
                            <div class="col-span-3 form-group">
                                <label>เวลา</label>
                                <input type="time" id="admit_time" class="input-line">
                            </div>
                            <div class="col-span-3 form-group">
                                <label>วันที่ D/C</label>
                                <input type="date" id="dc_date" class="input-line" onchange="calcLOS()">
                            </div>
                            <div class="col-span-3 form-group">
                                <label>เวลา</label>
                                <input type="time" id="dc_time" class="input-line">
                            </div>
                            
                            <div class="col-span-4 form-group">
                                <label>จำนวนวันนอน (LOS)</label>
                                <input type="text" id="los_days" class="input-line" readonly style="color: var(--primary); font-weight: bold; background: #e0f2f1; text-align: center; border-radius: 4px;">
                            </div>
                            <div class="col-span-8 form-group">
                                <label>ความสามารถในการดูแลตนเอง</label>
                                <div class="radio-group">
                                    <label><input type="radio" name="self_care" value="Can"> ได้เอง</label>
                                    <label><input type="radio" name="self_care" value="Partial"> ได้บางส่วน</label>
                                    <label><input type="radio" name="self_care" value="Cannot"> ไม่ได้เลย</label>
                                </div>
                            </div>

                            <div class="col-span-6 form-group">
                                <label>อุปกรณ์ที่ติดตัวกลับ</label>
                                <input type="text" id="equip_detail" class="input-line" placeholder="เช่น สายสวนปัสสาวะ, NG Tube">
                            </div>
                            <div class="col-span-6 form-group">
                                <label>ผู้ดูแลหลัก (Caregiver)</label>
                                <input type="text" id="caregiver" class="input-line" placeholder="ชื่อ-สกุล / ความสัมพันธ์">
                            </div>
                            
                            <div class="col-span-12 form-group">
                                <label>แผนการจำหน่าย</label>
                                <div class="radio-group">
                                    <label><input type="radio" name="hhc" value="No"> ไม่ส่งต่อ</label>
                                    <label><input type="radio" name="hhc" value="Yes"> ส่งต่อเยี่ยมบ้าน (HHC)</label>
                                    <span style="margin-left: 20px;">ไปยัง:</span>
                                    <input type="text" id="destination" class="input-line" style="width: 200px;" placeholder="ที่อยู่/สถานพยาบาล">
                                </div>
                            </div>
                        </div>

                        <table class="dmethod-table">
                            <thead>
                                <tr>
                                    <th class="col-topic">หัวข้อ (D-M-E-T-H-O-D)</th>
                                    <th class="col-eval">ประเมิน</th>
                                    <th class="col-recv">ผู้รับ</th>
                                    <th class="col-method">วิธีการ</th>
                                    <th class="col-inst">ผู้สอน / วันที่</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>
                                        <span class="topic-header">D - Disease (โรค)</span>
                                        <input type="text" id="d_text" class="input-line" placeholder="ระบุโรค...">
                                        <div class="sub-topic">- ภาวะแทรกซ้อน</div>
                                    </td>
                                    <td><input type="text" id="d_eval" class="input-line" style="text-align: center;"></td>
                                    <td><label><input type="checkbox" id="d_pt"> ผู้ป่วย</label><br><label><input type="checkbox" id="d_rel"> ญาติ</label></td>
                                    <td><label><input type="checkbox" id="d_talk"> พูดคุย</label><br><label><input type="checkbox" id="d_doc"> เอกสาร</label></td>
                                    <td><input type="text" id="d_sign" class="input-line"></td>
                                </tr>
                                <tr>
                                    <td>
                                        <span class="topic-header">M - Medication (ยา)</span>
                                        <input type="text" id="m_text" class="input-line" placeholder="สรรพคุณ/วิธีใช้...">
                                    </td>
                                    <td><input type="text" id="m_eval" class="input-line" style="text-align: center;"></td>
                                    <td><label><input type="checkbox" id="m_pt"> ผู้ป่วย</label><br><label><input type="checkbox" id="m_rel"> ญาติ</label></td>
                                    <td><label><input type="checkbox" id="m_talk"> พูดคุย</label><br><label><input type="checkbox" id="m_doc"> เอกสาร</label></td>
                                    <td><input type="text" id="m_sign" class="input-line"></td>
                                </tr>
                                <tr>
                                    <td>
                                        <span class="topic-header">E - Environment (สภาพแวดล้อม)</span>
                                        <input type="text" id="e_text" class="input-line" placeholder="การจัดบ้าน...">
                                    </td>
                                    <td><input type="text" id="e_eval" class="input-line" style="text-align: center;"></td>
                                    <td><label><input type="checkbox" id="e_pt"> ผู้ป่วย</label><br><label><input type="checkbox" id="e_rel"> ญาติ</label></td>
                                    <td><label><input type="checkbox" id="e_talk"> พูดคุย</label><br><label><input type="checkbox" id="e_doc"> เอกสาร</label></td>
                                    <td><input type="text" id="e_sign" class="input-line"></td>
                                </tr>
                                <tr>
                                    <td>
                                        <span class="topic-header">T - Treatment (การรักษา)</span>
                                        <input type="text" id="t_text" class="input-line" placeholder="อุปกรณ์/แผล...">
                                    </td>
                                    <td><input type="text" id="t_eval" class="input-line" style="text-align: center;"></td>
                                    <td><label><input type="checkbox" id="t_pt"> ผู้ป่วย</label><br><label><input type="checkbox" id="t_rel"> ญาติ</label></td>
                                    <td><label><input type="checkbox" id="t_talk"> พูดคุย</label><br><label><input type="checkbox" id="t_demo"> สาธิต</label></td>
                                    <td><input type="text" id="t_sign" class="input-line"></td>
                                </tr>
                                <tr>
                                    <td>
                                        <span class="topic-header">H - Health (สุขภาพ)</span>
                                        <input type="text" id="h_text" class="input-line" placeholder="การออกกำลังกาย...">
                                    </td>
                                    <td><input type="text" id="h_eval" class="input-line" style="text-align: center;"></td>
                                    <td><label><input type="checkbox" id="h_pt"> ผู้ป่วย</label><br><label><input type="checkbox" id="h_rel"> ญาติ</label></td>
                                    <td><label><input type="checkbox" id="h_talk"> พูดคุย</label><br><label><input type="checkbox" id="h_doc"> เอกสาร</label></td>
                                    <td><input type="text" id="h_sign" class="input-line"></td>
                                </tr>
                                <tr>
                                    <td>
                                        <span class="topic-header">O - Outpatient (นัดหมาย)</span>
                                        <input type="text" id="o_text" class="input-line" placeholder="วันนัด/ฉุกเฉิน...">
                                    </td>
                                    <td><input type="text" id="o_eval" class="input-line" style="text-align: center;"></td>
                                    <td><label><input type="checkbox" id="o_pt"> ผู้ป่วย</label><br><label><input type="checkbox" id="o_rel"> ญาติ</label></td>
                                    <td><label><input type="checkbox" id="o_talk"> พูดคุย</label><br><label><input type="checkbox" id="o_doc"> ใบนัด</label></td>
                                    <td><input type="text" id="o_sign" class="input-line"></td>
                                </tr>
                                <tr>
                                    <td>
                                        <span class="topic-header">D - Diet (โภชนาการ)</span>
                                        <input type="text" id="diet_text" class="input-line" placeholder="อาหารเฉพาะโรค...">
                                    </td>
                                    <td><input type="text" id="diet_eval" class="input-line" style="text-align: center;"></td>
                                    <td><label><input type="checkbox" id="diet_pt"> ผู้ป่วย</label><br><label><input type="checkbox" id="diet_rel"> ญาติ</label></td>
                                    <td><label><input type="checkbox" id="diet_talk"> พูดคุย</label><br><label><input type="checkbox" id="diet_doc"> เอกสาร</label></td>
                                    <td><input type="text" id="diet_sign" class="input-line"></td>
                                </tr>
                            </tbody>
                        </table>

                        <div class="history-section">
                            <div class="history-title"><i class="fas fa-history"></i> ประวัติการบันทึก (History Log)</div>
                            <table class="history-table">
                                <thead>
                                    <tr>
                                        <th style="width: 25%;">วัน-เวลา</th>
                                        <th style="width: 15%;">การกระทำ</th>
                                        <th>ผู้บันทึก (Role)</th>
                                    </tr>
                                </thead>
                                <tbody id="historyTableBody">
                                    <tr><td colspan="3" style="text-align:center;">ยังไม่มีประวัติ</td></tr>
                                </tbody>
                            </table>
                        </div>

                        <div style="text-align: right; margin-top: 20px; font-size: 11px; color: #999;">FM-PFE-CBH-001 (Rev.2025)</div>
                    </div>
                </td>
            </tr>
        </tbody>
    </table>

    <div class="action-bar">
        <button class="btn btn-delete" onclick="deleteData()"><i class="fas fa-trash-alt"></i> ลบข้อมูล</button>
        <button class="btn btn-save" onclick="saveData()"><i class="fas fa-save"></i> บันทึก</button>
        <button class="btn btn-pdf" onclick="exportPDF()"><i class="fas fa-file-pdf"></i> PDF</button>
    </div>

    <script>
        let currentAN = "";
        let historyLog = [];

        window.onload = function() {
            const patientProfile = JSON.parse(localStorage.getItem('patientProfile'));
            
            if (patientProfile) {
                currentAN = patientProfile.an;
                
                // 1. Update Fixed Nav
                document.getElementById('navName').innerText = patientProfile.name;
                document.getElementById('navHN').innerText = patientProfile.hn;
                
                // 2. Update Document Header (Repeating in PDF)
                document.getElementById('headerPatientInfo').innerHTML = `
                    <div class="pt-name">${patientProfile.name}</div>
                    <div class="pt-meta">HN: ${patientProfile.hn} | AN: ${patientProfile.an}</div>
                    <div class="pt-meta">Ward: ${patientProfile.ward || '-'}</div>
                `;

                // 3. Load Data & History
                loadData(currentAN);
            } else {
                Swal.fire({ icon: 'error', title: 'ไม่พบข้อมูลผู้ป่วย' }).then(() => {
                    window.location.href = 'patient_list.html';
                });
            }
        };

        function calcLOS() {
            const admit = new Date(document.getElementById('admit_date').value);
            const dc = new Date(document.getElementById('dc_date').value);
            if (admit && dc && dc >= admit) {
                const diffDays = Math.ceil(Math.abs(dc - admit) / (1000 * 60 * 60 * 24));
                document.getElementById('los_days').value = diffDays;
            } else {
                document.getElementById('los_days').value = "";
            }
        }

        function getAllInputs() {
            return document.querySelectorAll('input, textarea, select');
        }

        function saveData() {
            if (!currentAN) return;

            // 1. Collect Form Data
            let data = {};
            const inputs = getAllInputs();
            inputs.forEach(el => {
                if (el.type === 'radio' || el.type === 'checkbox') {
                    if (el.type === 'radio' && el.checked) data[el.name] = el.value;
                    if (el.type === 'checkbox') data[el.id] = el.checked;
                } else {
                    data[el.id] = el.value;
                }
            });

            // 2. Add History Log
            const now = new Date();
            const logEntry = {
                timestamp: now.toLocaleString('th-TH'),
                action: 'บันทึก/แก้ไข',
                user: 'RN (Demo)' // ในระบบจริงดึงจาก Login
            };
            historyLog.push(logEntry);

            // 3. Save to LocalStorage
            const saveObj = {
                formData: data,
                logs: historyLog
            };

            localStorage.setItem('PFE_Form_' + currentAN, JSON.stringify(saveObj));
            
            // Re-render history
            renderHistory();

            Swal.fire({
                icon: 'success',
                title: 'บันทึกสำเร็จ',
                showConfirmButton: false,
                timer: 1500
            });
        }

        function loadData(an) {
            const raw = localStorage.getItem('PFE_Form_' + an);
            if (!raw) return;

            const parsed = JSON.parse(raw);
            
            // Support old format (just data) vs new format (data + logs)
            let data = parsed.formData || parsed; 
            historyLog = parsed.logs || [];

            // Fill Inputs
            const inputs = getAllInputs();
            inputs.forEach(el => {
                if (el.type === 'radio') {
                    if (data[el.name] === el.value) el.checked = true;
                } else if (el.type === 'checkbox') {
                    if (data[el.id]) el.checked = true;
                } else {
                    if (data[el.id] !== undefined) el.value = data[el.id];
                }
            });
            
            calcLOS();
            renderHistory();
        }

        function renderHistory() {
            const tbody = document.getElementById('historyTableBody');
            if (historyLog.length === 0) {
                tbody.innerHTML = '<tr><td colspan="3" style="text-align:center;">ยังไม่มีประวัติ</td></tr>';
                return;
            }
            // Show latest last
            let html = '';
            historyLog.forEach(log => {
                html += `
                    <tr>
                        <td>${log.timestamp}</td>
                        <td><span style="color:var(--primary); font-weight:bold;">${log.action}</span></td>
                        <td>${log.user}</td>
                    </tr>
                `;
            });
            tbody.innerHTML = html;
        }

        function deleteData() {
            if (!currentAN) return;
            Swal.fire({
                title: 'ยืนยันการลบ?',
                text: "ข้อมูลจะหายไปถาวร",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#ef5350',
                confirmButtonText: 'ลบข้อมูล'
            }).then((result) => {
                if (result.isConfirmed) {
                    localStorage.removeItem('PFE_Form_' + currentAN);
                    location.reload();
                }
            });
        }

        function exportPDF() {
            const element = document.getElementById('printableArea');
            
            // Fix checkboxes for print
            document.querySelectorAll('input').forEach(input => {
                if(input.type === 'checkbox' || input.type === 'radio'){
                    if(input.checked) input.setAttribute('checked', 'checked');
                    else input.removeAttribute('checked');
                } else {
                    input.setAttribute('value', input.value);
                }
            });

            const opt = {
                margin: 5,
                filename: `PFE_${currentAN}.pdf`,
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { scale: 2, useCORS: true },
                jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' },
                pagebreak: { mode: ['avoid-all', 'css', 'legacy'] }
            };

            html2pdf().set(opt).from(element).save();
        }
    </script>

</body>
</html>

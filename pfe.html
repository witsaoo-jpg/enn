<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Patient and Family Education (PFE)</title>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        :root {
            --primary: #00796b;
            --border-color: #333;
            --bg-color: #f5f5f5;
        }

        body {
            font-family: 'Sarabun', sans-serif;
            background: var(--bg-color);
            margin: 0;
            padding: 20px;
            font-size: 12px; /* ปรับ font ให้เล็กพอดีตารางแน่นๆ */
            line-height: 1.4;
        }

        .container {
            width: 210mm;
            min-height: 297mm;
            margin: 0 auto;
            background: #fff;
            padding: 20px 30px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
            position: relative;
            box-sizing: border-box;
        }

        /* --- Header --- */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 10px;
        }
        .hospital-logo {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .hospital-logo img {
            height: 50px; /* Placeholder for logo */
            width: 50px;
            background: #ddd;
            border-radius: 50%;
        }
        .hospital-name h2 { margin: 0; font-size: 18px; color: var(--primary); }
        .hospital-name h3 { margin: 0; font-size: 14px; font-weight: normal; }

        .sticker-box {
            width: 250px;
            height: 60px;
            border: 1px solid #000;
            padding: 5px;
            font-size: 12px;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        h1.title {
            text-align: center;
            font-size: 16px;
            font-weight: bold;
            margin: 10px 0;
            text-transform: uppercase;
        }

        /* --- Top Form Inputs --- */
        .top-form {
            margin-bottom: 10px;
        }
        .inline-input {
            border: none;
            border-bottom: 1px dotted #000;
            font-family: 'Sarabun';
            font-size: 12px;
            padding: 0 5px;
            background: transparent;
        }
        .inline-input:focus { outline: none; border-bottom: 1px solid var(--primary); }
        
        .row { display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 5px; align-items: baseline; }
        .check-label { margin-left: 5px; margin-right: 15px; cursor: pointer; }
        
        /* --- Table Styling --- */
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 5px;
            font-size: 12px;
        }
        th, td {
            border: 1px solid #000;
            padding: 4px;
            vertical-align: top;
        }
        th {
            background-color: #e0e0e0;
            text-align: center;
            font-weight: bold;
        }
        
        /* Column Widths */
        .col-topic { width: 35%; }
        .col-eval { width: 10%; }
        .col-receiver { width: 15%; }
        .col-method { width: 15%; }
        .col-instructor { width: 25%; }

        /* Input inside table */
        .tbl-input {
            width: 95%;
            border: none;
            border-bottom: 1px dotted #ccc;
            font-family: 'Sarabun';
            font-size: 12px;
        }
        .tbl-checkbox { transform: scale(0.9); margin-right: 3px; }

        /* D-M-E-T-H-O-D Headers */
        .group-header {
            background-color: #f9f9f9;
            font-weight: bold;
        }

        /* Footer */
        .footer-id {
            text-align: right;
            font-size: 10px;
            margin-top: 5px;
            font-weight: bold;
        }

        /* --- Action Bar --- */
        .action-bar {
            position: fixed;
            bottom: 20px;
            right: 20px;
            display: flex;
            gap: 10px;
            z-index: 1000;
        }
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 25px;
            color: white;
            font-family: 'Sarabun';
            font-weight: bold;
            cursor: pointer;
            box-shadow: 0 4px 6px rgba(0,0,0,0.2);
            transition: 0.2s;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        .btn:hover { transform: translateY(-2px); }
        .btn-save { background: #2e7d32; }
        .btn-pdf { background: #1565c0; }
        .btn-del { background: #c62828; }
        .btn-back { background: #616161; }

        /* Print Settings */
        @media print {
            .action-bar { display: none; }
            body { background: white; padding: 0; }
            .container { box-shadow: none; margin: 0; width: 100%; height: auto; }
        }
    </style>
</head>
<body>

<div class="container" id="printableArea">
    <div class="header">
        <div class="hospital-logo">
            <div style="width: 50px; height: 50px; border-radius: 50%; background: #ccc; display: flex; justify-content: center; align-items: center; font-size: 8px;">LOGO</div>
            <div class="hospital-name">
                <h2>โรงพยาบาลชลบุรี</h2>
                <h3>Chonburi Hospital</h3>
            </div>
        </div>
        <div class="sticker-box" id="stickerBox">
            <div style="text-align: center; color: #999;">ติดสติ๊กเกอร์ชื่อผู้ป่วย</div>
            <div id="stickerData" style="font-weight: bold; margin-top: 5px;"></div>
        </div>
    </div>

    <h1 class="title">PATIENT AND FAMILY EDUCATION</h1>

    <div class="top-form">
        <div class="row">
            วันที่มาโรงพยาบาล <input type="text" id="admit_date" class="inline-input" style="width: 100px;">
            เวลา <input type="text" id="admit_time" class="inline-input" style="width: 60px;">
            วันที่กลับบ้าน <input type="text" id="dc_date" class="inline-input" style="width: 100px;">
            เวลา <input type="text" id="dc_time" class="inline-input" style="width: 60px;">
            น. ระยะเวลาที่นอนโรงพยาบาล <input type="text" id="los" class="inline-input" style="width: 40px;"> วัน
        </div>
        <div class="row">
            ความสามารถในการดูแลตนเอง 
            <label class="check-label"><input type="radio" name="self_care" value="Can"> ( ) ช่วยเหลือตนเองได้</label>
            <label class="check-label"><input type="radio" name="self_care" value="Partial"> ( ) ช่วยเหลือตนเองได้บางส่วน</label>
            <label class="check-label"><input type="radio" name="self_care" value="Cannot"> ( ) ช่วยเหลือตนเองไม่ได้</label>
        </div>
        <div class="row">
            อุปกรณ์การรักษาพยาบาลที่ติดตัวกลับไป 
            <label class="check-label"><input type="radio" name="equip" value="No"> ( ) ไม่มี</label>
            <label class="check-label"><input type="radio" name="equip" value="Yes"> ( ) มี (ระบุ)</label>
            <input type="text" id="equip_detail" class="inline-input" style="flex-grow: 1;">
        </div>
        <div class="row">
            ระบุผู้ดูแลผู้ป่วย <input type="text" id="caregiver" class="inline-input" style="flex-grow: 1;">
        </div>
        <div class="row">
            สถานที่พักเมื่อออกจากโรงพยาบาล <input type="text" id="destination" class="inline-input" style="flex-grow: 1;">
        </div>
        <div class="row">
            ส่งต่อ Home Health Care 
            <label class="check-label"><input type="radio" name="hhc" value="Send"> ( ) ส่ง</label>
            <label class="check-label"><input type="radio" name="hhc" value="NotSend"> ( ) ไม่ส่ง</label>
        </div>
    </div>

    <table>
        <thead>
            <tr>
                <th class="col-topic">คำแนะนำ / กิจกรรม</th>
                <th class="col-eval">ประเมินผล</th>
                <th class="col-receiver">ผู้รับคำแนะนำ</th>
                <th class="col-method">วิธีการสอน สื่อ เอกสาร</th>
                <th class="col-instructor">ผู้สอน / วันที่สอน</th>
            </tr>
        </thead>
        <tbody>
            <tr>
                <td><strong>D - โรค /ภาวะเจ็บป่วย</strong><input type="text" id="d_disease_text" class="tbl-input" placeholder="..."></td>
                <td><input type="text" id="d_disease_eval" class="tbl-input"></td>
                <td><label><input type="checkbox" id="d_disease_pt" class="tbl-checkbox">ผู้ป่วย</label><br><label><input type="checkbox" id="d_disease_rel" class="tbl-checkbox">ญาติ ระบุ <input type="text" id="d_disease_rel_text" style="width:40px; border:none; border-bottom:1px dotted #000;"></label></td>
                <td><label><input type="checkbox" id="d_disease_m_expl" class="tbl-checkbox">อธิบาย</label><br><label><input type="checkbox" id="d_disease_m_doc" class="tbl-checkbox">เอกสาร</label></td>
                <td><input type="text" id="d_disease_inst" class="tbl-input" placeholder="ชื่อ/วันที่"></td>
            </tr>
            <tr>
                <td>ภาวะแทรกซ้อน<br><input type="text" id="d_comp_text" class="tbl-input"></td>
                <td><input type="text" id="d_comp_eval" class="tbl-input"></td>
                <td><label><input type="checkbox" id="d_comp_pt" class="tbl-checkbox">ผู้ป่วย</label><br><label><input type="checkbox" id="d_comp_rel" class="tbl-checkbox">ญาติ ระบุ...</label></td>
                <td><label><input type="checkbox" id="d_comp_m_expl" class="tbl-checkbox">อธิบาย</label><br><label><input type="checkbox" id="d_comp_m_doc" class="tbl-checkbox">เอกสาร</label></td>
                <td><input type="text" id="d_comp_inst" class="tbl-input"></td>
            </tr>
            <tr>
                <td>การสังเกตอาการผิดปกติที่ควรพบแพทย์<br><input type="text" id="d_observe_text" class="tbl-input"></td>
                <td><input type="text" id="d_observe_eval" class="tbl-input"></td>
                <td><label><input type="checkbox" id="d_observe_pt" class="tbl-checkbox">ผู้ป่วย</label><br><label><input type="checkbox" id="d_observe_rel" class="tbl-checkbox">ญาติ ระบุ...</label></td>
                <td><label><input type="checkbox" id="d_observe_m_expl" class="tbl-checkbox">อธิบาย</label><br><label><input type="checkbox" id="d_observe_m_doc" class="tbl-checkbox">เอกสาร</label></td>
                <td><input type="text" id="d_observe_inst" class="tbl-input"></td>
            </tr>

            <tr>
                <td><strong>M - การใช้ยา</strong> / คำแนะนำการยา / ปฏิกิริยาระหว่างอาหารและยา<br><input type="text" id="m_med_text" class="tbl-input"></td>
                <td><input type="text" id="m_med_eval" class="tbl-input"></td>
                <td><label><input type="checkbox" id="m_med_pt" class="tbl-checkbox">ผู้ป่วย</label><br><label><input type="checkbox" id="m_med_rel" class="tbl-checkbox">ญาติ ระบุ...</label></td>
                <td><label><input type="checkbox" id="m_med_m_expl" class="tbl-checkbox">อธิบาย</label><br><label><input type="checkbox" id="m_med_m_doc" class="tbl-checkbox">เอกสาร</label></td>
                <td><input type="text" id="m_med_inst" class="tbl-input"></td>
            </tr>

            <tr>
                <td><strong>E - การจัดสภาพแวดล้อมที่บ้าน</strong><br><input type="text" id="e_env_text" class="tbl-input"></td>
                <td><input type="text" id="e_env_eval" class="tbl-input"></td>
                <td><label><input type="checkbox" id="e_env_pt" class="tbl-checkbox">ผู้ป่วย</label><br><label><input type="checkbox" id="e_env_rel" class="tbl-checkbox">ญาติ ระบุ...</label></td>
                <td><label><input type="checkbox" id="e_env_m_expl" class="tbl-checkbox">อธิบาย</label><br><label><input type="checkbox" id="e_env_m_doc" class="tbl-checkbox">เอกสาร</label></td>
                <td><input type="text" id="e_env_inst" class="tbl-input"></td>
            </tr>
            <tr>
                <td>สิ่งที่ควรระวัง / การจัดการปัญหาเศรษฐกิจ<br><input type="text" id="e_caution_text" class="tbl-input"></td>
                <td><input type="text" id="e_caution_eval" class="tbl-input"></td>
                <td><label><input type="checkbox" id="e_caution_pt" class="tbl-checkbox">ผู้ป่วย</label><br><label><input type="checkbox" id="e_caution_rel" class="tbl-checkbox">ญาติ ระบุ...</label></td>
                <td><label><input type="checkbox" id="e_caution_m_expl" class="tbl-checkbox">อธิบาย</label><br><label><input type="checkbox" id="e_caution_m_doc" class="tbl-checkbox">เอกสาร</label></td>
                <td><input type="text" id="e_caution_inst" class="tbl-input"></td>
            </tr>

            <tr>
                <td><strong>T - คำแนะนำการใช้อุปกรณ์ทางการแพทย์</strong><br><input type="text" id="t_equip_text" class="tbl-input"></td>
                <td><input type="text" id="t_equip_eval" class="tbl-input"></td>
                <td><label><input type="checkbox" id="t_equip_pt" class="tbl-checkbox">ผู้ป่วย</label><br><label><input type="checkbox" id="t_equip_rel" class="tbl-checkbox">ญาติ ระบุ...</label></td>
                <td><label><input type="checkbox" id="t_equip_m_expl" class="tbl-checkbox">อธิบาย</label><br><label><input type="checkbox" id="t_equip_m_doc" class="tbl-checkbox">เอกสาร</label></td>
                <td><input type="text" id="t_equip_inst" class="tbl-input"></td>
            </tr>
            <tr>
                <td>ภาวะเร่งด่วนที่ต้องพบแพทย์<br><input type="text" id="t_urgent_text" class="tbl-input"></td>
                <td><input type="text" id="t_urgent_eval" class="tbl-input"></td>
                <td><label><input type="checkbox" id="t_urgent_pt" class="tbl-checkbox">ผู้ป่วย</label><br><label><input type="checkbox" id="t_urgent_rel" class="tbl-checkbox">ญาติ ระบุ...</label></td>
                <td><label><input type="checkbox" id="t_urgent_m_expl" class="tbl-checkbox">อธิบาย</label><br><label><input type="checkbox" id="t_urgent_m_doc" class="tbl-checkbox">เอกสาร</label></td>
                <td><input type="text" id="t_urgent_inst" class="tbl-input"></td>
            </tr>

            <tr>
                <td><strong>H - การปฏิบัติตนเพื่อป้องกันภาวะแทรกซ้อน</strong><br><input type="text" id="h_prevent_text" class="tbl-input"></td>
                <td><input type="text" id="h_prevent_eval" class="tbl-input"></td>
                <td><label><input type="checkbox" id="h_prevent_pt" class="tbl-checkbox">ผู้ป่วย</label><br><label><input type="checkbox" id="h_prevent_rel" class="tbl-checkbox">ญาติ ระบุ...</label></td>
                <td><label><input type="checkbox" id="h_prevent_m_expl" class="tbl-checkbox">อธิบาย</label><br><label><input type="checkbox" id="h_prevent_m_doc" class="tbl-checkbox">เอกสาร</label></td>
                <td><input type="text" id="h_prevent_inst" class="tbl-input"></td>
            </tr>
            <tr>
                <td>ข้อจำกัด<br><input type="text" id="h_limit_text" class="tbl-input"></td>
                <td><input type="text" id="h_limit_eval" class="tbl-input"></td>
                <td><label><input type="checkbox" id="h_limit_pt" class="tbl-checkbox">ผู้ป่วย</label><br><label><input type="checkbox" id="h_limit_rel" class="tbl-checkbox">ญาติ ระบุ...</label></td>
                <td><label><input type="checkbox" id="h_limit_m_expl" class="tbl-checkbox">อธิบาย</label><br><label><input type="checkbox" id="h_limit_m_doc" class="tbl-checkbox">เอกสาร</label></td>
                <td><input type="text" id="h_limit_inst" class="tbl-input"></td>
            </tr>

            <tr>
                <td><strong>O - วันที่นัดตรวจ</strong>...........................................<br>คลินิก..............................แพทย์...............................<br>การเตรียมตัว.....................................................</td>
                <td><input type="text" id="o_appt_eval" class="tbl-input"></td>
                <td><label><input type="checkbox" id="o_appt_pt" class="tbl-checkbox">ผู้ป่วย</label><br><label><input type="checkbox" id="o_appt_rel" class="tbl-checkbox">ญาติ ระบุ...</label></td>
                <td><label><input type="checkbox" id="o_appt_m_expl" class="tbl-checkbox">อธิบาย</label><br><label><input type="checkbox" id="o_appt_m_doc" class="tbl-checkbox">เอกสาร</label></td>
                <td><input type="text" id="o_appt_inst" class="tbl-input"></td>
            </tr>
            <tr>
                <td>การติดต่อขอความช่วยเหลือในกรณีฉุกเฉิน<br><input type="text" id="o_emer_text" class="tbl-input"></td>
                <td><input type="text" id="o_emer_eval" class="tbl-input"></td>
                <td><label><input type="checkbox" id="o_emer_pt" class="tbl-checkbox">ผู้ป่วย</label><br><label><input type="checkbox" id="o_emer_rel" class="tbl-checkbox">ญาติ ระบุ...</label></td>
                <td><label><input type="checkbox" id="o_emer_m_expl" class="tbl-checkbox">อธิบาย</label><br><label><input type="checkbox" id="o_emer_m_doc" class="tbl-checkbox">เอกสาร</label></td>
                <td><input type="text" id="o_emer_inst" class="tbl-input"></td>
            </tr>
            <tr>
                <td>สถานที่ส่งต่อผู้ป่วยให้ได้รับการดูแลต่อเนื่อง<br><input type="text" id="o_refer_text" class="tbl-input"></td>
                <td><input type="text" id="o_refer_eval" class="tbl-input"></td>
                <td><label><input type="checkbox" id="o_refer_pt" class="tbl-checkbox">ผู้ป่วย</label><br><label><input type="checkbox" id="o_refer_rel" class="tbl-checkbox">ญาติ ระบุ...</label></td>
                <td><label><input type="checkbox" id="o_refer_m_expl" class="tbl-checkbox">อธิบาย</label><br><label><input type="checkbox" id="o_refer_m_doc" class="tbl-checkbox">เอกสาร</label></td>
                <td><input type="text" id="o_refer_inst" class="tbl-input"></td>
            </tr>

            <tr>
                <td><strong>D - อาหารที่เหมาะสมกับโรค</strong><br><input type="text" id="d_diet_text" class="tbl-input"></td>
                <td><input type="text" id="d_diet_eval" class="tbl-input"></td>
                <td><label><input type="checkbox" id="d_diet_pt" class="tbl-checkbox">ผู้ป่วย</label><br><label><input type="checkbox" id="d_diet_rel" class="tbl-checkbox">ญาติ ระบุ...</label></td>
                <td><label><input type="checkbox" id="d_diet_m_expl" class="tbl-checkbox">อธิบาย</label><br><label><input type="checkbox" id="d_diet_m_doc" class="tbl-checkbox">เอกสาร</label></td>
                <td><input type="text" id="d_diet_inst" class="tbl-input"></td>
            </tr>
            <tr>
                <td>อาหารที่ควรหลีกเลี่ยง<br><input type="text" id="d_avoid_text" class="tbl-input"></td>
                <td><input type="text" id="d_avoid_eval" class="tbl-input"></td>
                <td><label><input type="checkbox" id="d_avoid_pt" class="tbl-checkbox">ผู้ป่วย</label><br><label><input type="checkbox" id="d_avoid_rel" class="tbl-checkbox">ญาติ ระบุ...</label></td>
                <td><label><input type="checkbox" id="d_avoid_m_expl" class="tbl-checkbox">อธิบาย</label><br><label><input type="checkbox" id="d_avoid_m_doc" class="tbl-checkbox">เอกสาร</label></td>
                <td><input type="text" id="d_avoid_inst" class="tbl-input"></td>
            </tr>
        </tbody>
    </table>

    <div class="footer-id">FM-PFE-CBH-001</div>
</div>

<div class="action-bar">
    <button class="btn btn-back" onclick="window.location.href='patient_list.html'"><i class="fas fa-arrow-left"></i> ย้อนกลับ</button>
    <button class="btn btn-del" onclick="deleteData()"><i class="fas fa-trash"></i> ลบ</button>
    <button class="btn btn-save" onclick="saveData()"><i class="fas fa-save"></i> บันทึก</button>
    <button class="btn btn-pdf" onclick="exportPDF()"><i class="fas fa-file-pdf"></i> PDF</button>
</div>

<script>
    let currentAN = "";

    window.onload = function() {
        // 1. ดึงข้อมูลผู้ป่วยจาก localStorage (จากหน้า list)
        const patientProfile = JSON.parse(localStorage.getItem('patientProfile'));
        
        if (patientProfile) {
            currentAN = patientProfile.an;
            // สร้าง Sticker
            const stickerHTML = `
                ${patientProfile.name}<br>
                HN: ${patientProfile.hn} AN: ${patientProfile.an}<br>
                WARD: ${patientProfile.ward || '-'}
            `;
            document.getElementById('stickerData').innerHTML = stickerHTML;
            
            // โหลดข้อมูลเดิมถ้ามี
            loadData(currentAN);
        } else {
            Swal.fire('ข้อผิดพลาด', 'ไม่พบข้อมูลผู้ป่วย กรุณาเลือกผู้ป่วยจากหน้ารายการ', 'error').then(() => {
                 window.location.href = 'patient_list.html';
            });
        }
    };

    function getAllInputs() {
        return document.querySelectorAll('input[type="text"], input[type="radio"], input[type="checkbox"]');
    }

    function saveData() {
        if (!currentAN) return;

        let data = {};
        const inputs = getAllInputs();

        inputs.forEach(el => {
            if (el.type === 'radio') {
                if (el.checked) data[el.name] = el.value;
            } else if (el.type === 'checkbox') {
                data[el.id] = el.checked;
            } else {
                data[el.id] = el.value;
            }
        });

        localStorage.setItem('PFE_Form_' + currentAN, JSON.stringify(data));
        Swal.fire('บันทึกสำเร็จ', 'ข้อมูลถูกบันทึกเรียบร้อยแล้ว', 'success');
    }

    function loadData(an) {
        const raw = localStorage.getItem('PFE_Form_' + an);
        if (!raw) return;

        const data = JSON.parse(raw);
        const inputs = getAllInputs();

        inputs.forEach(el => {
            if (el.type === 'radio') {
                if (data[el.name] === el.value) el.checked = true;
            } else if (el.type === 'checkbox') {
                if (data[el.id]) el.checked = true;
            } else {
                if (data[el.id] !== undefined) el.value = data[el.id];
            }
        });
    }

    function deleteData() {
        if (!currentAN) return;
        
        Swal.fire({
            title: 'ยืนยันการลบ?',
            text: "ข้อมูลของ AN นี้จะหายไปทั้งหมด",
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#d33',
            confirmButtonText: 'ลบข้อมูล'
        }).then((result) => {
            if (result.isConfirmed) {
                localStorage.removeItem('PFE_Form_' + currentAN);
                location.reload();
            }
        });
    }

    function exportPDF() {
        const element = document.getElementById('printableArea');
        const opt = {
            margin: 0,
            filename: `PFE_${currentAN}.pdf`,
            image: { type: 'jpeg', quality: 0.98 },
            html2canvas: { scale: 2 },
            jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
        };

        // Prepare inputs for PDF (convert values to attributes)
        document.querySelectorAll('input').forEach(input => {
            if(input.type === 'checkbox' || input.type === 'radio'){
                if(input.checked) input.setAttribute('checked', 'checked');
            } else {
                input.setAttribute('value', input.value);
            }
        });

        html2pdf().set(opt).from(element).save();
    }
</script>

</body>
</html>
